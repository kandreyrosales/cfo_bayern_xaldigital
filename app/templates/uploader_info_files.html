{% extends 'base.html' %}
{% block content %}
<div class="ms-5 me-5">
    <div id="loadingSpinner" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div class="accordion" id="accordionExample">
        <div class="accordion-item">
            <h3 class="accordion-header">
                <button
                        class="accordion-button fw-bold text_font"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                    Importador de archivos Bancarios Semanal
                </button>
            </h3>
            <div id="collapseOne" class="accordion-collapse collapse show  p-5" data-bs-parent="#accordionExample">
                <form
                        method="post"
                        enctype="multipart/form-data"
                        hx-post="/subir_info"
                        hx-trigger="submit"
                        hx-swap="innerHTML"
                        hx-target="#status-message"
                >
                    <div class="row align-items-start">
                        <div class="row">
                            <div class="col-12 col-md-6 col-lg-6 mb-4">
                                <p class="form-label text_font mb-2 h6">Bancos</p>
                                <input
                                        class="input_button form-control btn-outline-light btn-sm rounded-3"
                                        type="file"
                                        name="banks"
                                        id="banks"
                                        accept=".xlsx"
                                        required>
                            </div>
                            <div class="col-12 col-md-6 col-lg-6 mb-4">
                                <p class="form-label text_font mb-2 h6">
                                    Valor del dólar, consultar valor
                                    <a href="https://www.dof.gob.mx/#gsc.tab=0" target="_blank">aquí</a>
                                </p>
                                <input
                                        class="input_button form-control btn-outline-light btn-sm rounded-3"
                                        type="number"
                                        step="0.01"
                                        min="0"
                                        name="dof"
                                        id="dof"
                                        required>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <input class="btn btn-light validador_ieps_table_button_headers" type="submit"
                               value="Subir Archivos">
                    </div>
                </form>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button
                            class="accordion-button collapsed fw-bold"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseTwo"
                            aria-expanded="false" aria-controls="collapseTwo">
                        Importador de archivos SAT
                    </button>
                </h2>
                <div id="collapseTwo" class="accordion-collapse collapse p-5" data-bs-parent="#accordionExample">
                    <form
                            method="post"
                            enctype="multipart/form-data"
                            hx-post="/subir_info_sat"
                            hx-trigger="submit"
                            hx-swap="innerHTML"
                            hx-target="#status-message"
                    >
                        <div class="row align-items-start">
                            <div class="row">
                                <div class="col-12 col-md-6 col-lg-6 mb-4">
                                    <p class="form-label text_font mb-2 h6">
                                        SAT (Límite de 10 archivos por carga.)
                                    </p>
                                    <input
                                            class="form-control btn-outline-light btn-sm rounded-3 input_button"
                                            type="file"
                                            name="sat"
                                            accept=".xml"
                                            required
                                            multiple
                                            id="sapInput"
                                    >
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <input class="btn btn-light validador_ieps_table_button_headers" type="submit"
                                   value="Subir Archivos">
                        </div>
                    </form>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button
                            class="accordion-button collapsed fw-bold text_font"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseThree"
                            aria-expanded="false"
                            aria-controls="collapseThree">
                        Importador de archivos SAP
                    </button>
                </h2>
                <div id="collapseThree" class="accordion-collapse collapse p-5" data-bs-parent="#accordionExample">
                    <div class="accordion-body">
                        <form
                                action="/subir_info_sat_sap"
                                method="post"
                                enctype="multipart/form-data"
                                hx-post="/subir_info_sat_sap"
                                hx-trigger="submit"
                                hx-swap="innerHTML"
                                hx-target="#status-message"
                        >
                            <div class="row align-items-start mb-5">
                                <div class="row">

                                    <div class="col-12 col-md-6 col-lg-6 mb-4">
                                        <p class="form-label text_font mb-2 h6">Auxiliares Cuentas de Bancos</p>
                                        <input
                                                class="form-control btn-outline-light btn-sm rounded-3 input_button"
                                                type="file"
                                                name="banks"
                                                accept=".xlsx"
                                                required
                                        >
                                    </div>
                                </div>
                                <div class="col">
                                    <input class="btn btn-light validador_ieps_table_button_headers"
                                           type="submit"
                                           value="Subir Archivos">
                                </div>
                            </div>
                        </form>

                        <form
                                action="/subir_info_sat_sap"
                                method="post"
                                enctype="multipart/form-data"
                                hx-post="/subir_info_sat_sap"
                                hx-trigger="submit"
                                hx-swap="innerHTML"
                                hx-target="#status-message"
                        >
                            <div class="row align-items-start mb-5">
                                <div class="row">
                                    <div class="col-12 col-md-6 col-lg-6 mb-4">
                                        <p class="form-label text_font mb-2 h6">BCS FBL5N</p>
                                        <input
                                                class="form-control btn-outline-light btn-sm rounded-3 input_button"
                                                type="file"
                                                name="bcs_fbl5n"
                                                accept=".xlsx"
                                                required
                                        >
                                    </div>
                                    <div class="col-12 col-md-6 col-lg-6 mb-4">
                                        <p class="form-label text_font mb-2 h6">BHC FBL5N</p>
                                        <input
                                                class="form-control btn-outline-light btn-sm rounded-3 input_button"
                                                type="file"
                                                name="bhc_fbl5n"
                                                accept=".xlsx"
                                                required
                                        >
                                    </div>
                                </div>

                                <div class="col">
                                    <input class="btn btn-light validador_ieps_table_button_headers"
                                           type="submit"
                                           value="Subir Archivos">
                                </div>
                            </div>
                        </form>

                        <form
                                action="/subir_info_sat_sap"
                                method="post"
                                enctype="multipart/form-data"
                                id="sap-form"
                                hx-post="/subir_info_sat_sap"
                                hx-trigger="submit"
                                hx-swap="innerHTML"
                                hx-target="#status-message"
                        >
                            <div class="row align-items-start">
                                <div class="row">
                                    <div class="col-12 col-md-6 col-lg-6 mb-4">
                                        <p class="form-label text_font mb-2 h6">BCS Auxiliares IVA, IEPS y Retención
                                            IVA</p>
                                        <input
                                                class="form-control btn-outline-light btn-sm rounded-3 input_button"
                                                type="file"
                                                name="bcs_fbl3n"
                                                accept=".xlsx"
                                                required
                                        >
                                    </div>
                                    <div class="col-12 col-md-6 col-lg-6 mb-4">
                                        <p class="form-label text_font mb-2 h6">BHC Auxiliares IVA, IEPS y Retención
                                            IVA</p>
                                        <input
                                                class="form-control btn-outline-light btn-sm rounded-3 input_button"
                                                type="file"
                                                name="bhc_fbl3n"
                                                accept=".xlsx"
                                                required
                                        >
                                    </div>
                                </div>

                            </div>

                            <div class="col">
                                <input class="btn btn-light validador_ieps_table_button_headers"
                                       type="submit"
                                       id="sap-form-btn"
                                       value="Subir Archivos">
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="status-message" style="display: none;"></div>
        </div>

        <script>
            document.body.addEventListener('htmx:configRequest', (event) => {
                document.getElementById('loadingSpinner').style.display = 'block';
            });
            document.body.addEventListener('htmx:afterRequest', (event) => {
                document.getElementById('loadingSpinner').style.display = 'none';
                let data;
                try {
                    data = JSON.parse(event.detail.xhr.responseText);
                } catch (e) {
                    Swal.fire({
                        title: 'Error!',
                        text: 'Failed to parse response.',
                        icon: 'error',
                        confirmButtonText: 'Try Again'
                    });
                    return;
                }
                if (event.detail.xhr.status === 200) {
                    Swal.fire({
                        title: 'Success!',
                        text: data.message || 'Files uploaded successfully.',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: data.message || 'Something went wrong.',
                        icon: 'error',
                        confirmButtonText: 'Try Again'
                    });
                }
            });
        </script>
        <script>
            const fileInput = document.getElementById('sapInput');
            const maxFiles = 11;

            fileInput.addEventListener('change', (event) => {
              const files = event.target.files;
              if (files.length > maxFiles) {
                 Swal.fire({
                        title: 'Error!',
                        text: `Solo puedes seleccionar un máximo de ${maxFiles} archivos`,
                        icon: 'error',
                        confirmButtonText: 'Try Again'
                    });
                event.target.value = ''; // Limpia la selección de archivos
              }
            });

        </script>
        {% endblock%}