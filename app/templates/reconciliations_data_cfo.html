{% extends 'base.html' %}
{% block content %}
    <div class="row">
        <div class="container-fluid">
            <div class="row align-items-start">
                <div class="col">
                    <table id="cfo_reconciliations" class="display" style="width:100%">
                        <thead>
                        <tr>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th colspan="5" class="title_group_cfo_table" style="background-color: #0BBEF0; text-align: center">XML Facturación</th>
                            <th colspan="2" class="title_group_cfo_table" style="background-color: #0BBEF0; text-align: center">Bancos</th>
                            <th colspan="6" class="title_group_cfo_table" style="background-color: #0BBEF0; text-align: center">SAP (FBL5N)</th>
                            <th colspan="5" class="title_group_cfo_table" style="background-color: #0BBEF0; text-align: center">SAT XML Complemento de Pago</th>
                            <th class="title_group_cfo_table" style="background-color: #83D333; text-align: center">Validador Aplicación de Pagos</th>
                            <th colspan="4" class="title_group_cfo_table" style="background-color: #83D333; text-align: center">Validador IVA</th>
                        </tr>
                        <tr class="titles_table">
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">RFC</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Factura</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Cliente</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Transacción</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Fecha</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Estado</th>

                            <!-- XML Facturacion -->
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">UUID</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Subtotal</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">IVA</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">IEPS</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Total</th>


                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Depósitos</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Nombre del Banco</th>

                            <!-- SAP FBL5 -->
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Document Number</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Clearing Document</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Subtotal</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">IVA</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">IEPS</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Total Aplicación</th>

                            <!-- SAT XML COMPLEMENTO DE PAGO -->
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">UUID Relacionado</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Subtotal</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">IVA Cobrado %</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">IEPS Cobrado %</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Total Aplicación</th>

                            <!-- VALIDADOR APLICACIÓN DE PAGOS -->
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;"></th>

                            <!-- SAT XML COMPLEMENTO DE PAGO -->
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Validador Subtotal</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Validador IVAS</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Validador IEPS</th>
                            <th style="background-color: #0F7093; font-family: Poppins;font-size: 18px;font-weight: 600;text-align: center;color: #FFFFFF;padding: 10px 80px;border-color: white;">Total Variación</th>

                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(function() {

            const language_data = {
                "sProcessing":    "Procesando...",
                "sLengthMenu":    "Mostrar _MENU_ registros",
                "sZeroRecords":   "No se encontraron resultados",
                "sEmptyTable":    "Ningún dato disponible en esta tabla",
                "sInfo":          "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                "sInfoEmpty":     "Mostrando registros del 0 al 0 de un total de 0 registros",
                "sInfoFiltered":  "(filtrado de un total de _MAX_ registros)",
                "sInfoPostFix":   "",
                "sSearch":        "Buscar:",
                "sUrl":           "",
                "sInfoThousands":  ",",
                "sLoadingRecords": "Cargando...",
                "oPaginate": {
                    "sFirst":    "Primero",
                    "sLast":    "Último",
                    "sNext":    "Siguiente",
                    "sPrevious": "Anterior"
                },
                "oAria": {
                    "sSortAscending":  ": Activar para ordenar la columna de manera ascendente",
                    "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                },
            };

            // Retrieve data for filters
            const start_date = localStorage.getItem('start_date');
            const end_date = localStorage.getItem('end_date');
            const rfc = localStorage.getItem('rfc');
            if (start_date !== null){
                $('#calendar_filter_start_date').val(start_date);
                $('#calendar_filter_end_date').val(end_date);
            }
            if(rfc !== null){
                $('#rfc_selector').val(rfc).trigger('change'); // Select option by value
                $('#rfc_selector option:first').prop('selected', true).trigger('change');
            }
            /* End retrieving data for filters */

            let minEl = $('#calendar_filter_start_date').val();
            let maxEl = $('#calendar_filter_end_date').val();

            // Initial URL for datatable
            let url_get_conciliations_view_data = "{{ url_for('get_filtered_data_conciliations') }}"+"?start_date="+minEl+"&end_date="+maxEl+"&rfc=all";

            // initial color of buttons
            $("#btn-conciliations-page").css("background-color", "#0075A6");
            $("#btn-conciliations-page").css("color", "#FFFFFF");
            $(".rect_conciliaciones_icon").attr("stroke", "white");



            let table = $('#cfo_reconciliations').DataTable({
                pageLength: 50,
                responsive: true,
                paging: true,
                scrollCollapse: true,
                scrollY: '300px',
                searching: false,
                info: false,
                ordering: false,
                "ajax": {
                    "type": "GET",
                    "url": url_get_conciliations_view_data, // Replace with your data endpoint URL
                    "dataSrc": function (data) {
                        return data.data || data; // Handle data structure from your API
                    }
                },
                "language": language_data
            });

            $("#search_data_filter_button").click(function() {
                let start_date_data = $('#calendar_filter_start_date').val();
                let end_date_data = $('#calendar_filter_end_date').val();
                let rfc_data = $("#rfc_selector option:selected").text();
                if (rfc_data === '' || rfc_data === 'Todos') {
                    rfc_data = 'all';
                }

                // Store data for filters
                localStorage.setItem('start_date', start_date_data);
                localStorage.setItem('end_date', end_date_data);
                localStorage.setItem('rfc', rfc_data);

                let url_get_conciliations = "{{ url_for('get_filtered_data_conciliations') }}" + "?start_date=" + start_date_data + "&end_date=" + end_date_data + "&rfc=" + rfc_data;
                table.destroy();
                table = $('#cfo_reconciliations').DataTable({
                    pageLength: 50,
                    responsive: true,
                    paging: true,
                    scrollY: '300px',
                    scrollCollapse: true,
                    searching: false,
                    info: false,
                    ordering: false,
                    "ajax": {
                        "type": "GET",
                        "url": url_get_conciliations, // Replace with your data endpoint URL
                        "dataSrc": function (data) {
                            return data.data || data; // Handle data structure from your API
                        }
                    },
                    "language": language_data
                });
            });
        });
    </script>
{% endblock %}

